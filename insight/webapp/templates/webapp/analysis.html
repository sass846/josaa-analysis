{% extends "webapp/base.html" %}

{% block title %}
Josaa Analysis
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row d-flex justify-content-between">
        <main class="col-md-9 flex-row">
            <h1>Analysis</h1>
            
            <div class="col-8 offset-2 my-5">
                <div class="card">
                    <div class="card-body">
                        <canvas id="analysis_chart"></canvas>
                    </div>
                </div>
            </div>
            <table class="table table-striped" id="table_analysis" style="display: none;">
                <thead>
                    <tr>
                        <th scope="col">Institute</th>
                        <th scope="col">Category</th>
                        <th scope="col">Gender</th>
                        <th scope="col">Branch</th>
                        <th scope="col">Opening Rank</th>
                        <th scope="col">Closing Rank</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in pg_data %}
                    <tr>
                        <td>{{ item.institute }}</td>
                        <td>{{ item.category }}</td>
                        <td>{{ item.gender }}</td>
                        <td>{{ item.branch }}</td>
                        <td>{{ item.opening_rank }}</td>
                        <td>{{ item.closing_rank }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <br>
            <div class="d-flex justify-content-center">
                <nav aria-label="Page navigation example" id="analysis_paginator" style="display:none">
                    <ul class="pagination">
                        {% if pg_data.has_previous %}
                        <li class="page-item"><a href="?page=1&{{ request.GET.urlencode }}" class="page-link">&laquo; First</a></li>
                        <li class="page-item"><a href="?page={{ pg_data.previous_page_number }}&{{ request.GET.urlencode }}" class="page-link">Previous</a></li>
                        {% endif %}

                        {% for i in pg_data.paginator.page_range %}
                        {% if i >= pg_data.number|add:"-3" and i <= pg_data.number|add:"3" %}
                        <li class="page-item {% if i == pg_data.number %}active{% endif %}"><a href="?page={{ i }}&{{ request.GET.urlencode }}" class="page-link">{{ i }}</a></li>
                        {% endif %}
                        {% endfor %}

                        {% if pg_data.has_next %}
                        <li class="page-item"><a href="?page={{ pg_data.next_page_number }}&{{ request.GET.urlencode }}" class="page-link">Next</a></li>
                        <li class="page-item"><a href="?page={{ pg_data.paginator.num_pages }}&{{ request.GET.urlencode }}" class="page-link">Last &raquo;</a></li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </main>

        <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
            <div class="position-sticky pt-3">
                <h5>Filter</h5>
                <form id="filterForm" method="get" action="{% url 'analysis' %}">
                    <div class="mb-3">
                        <label for="instituteName" class="form-label">Institute Name</label>
                        <select class="form-select" id="instituteName" name="institute_name" required>
                            <option value="">Select Institute Name</option>
                            {% for institute in institutes %}
                            <option value="{{ institute }}" {% if institute == request.GET.institute_name %}selected{% endif %}>{{ institute }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="category" class="form-label">Category</label>
                        <select class="form-select" id="category" name="category" required>
                            <option value="">Select Category</option>
                            <option value="OPEN" {% if "OPEN" == request.GET.category %}selected{% endif %}>Open</option>
                            <option value="OPEN (PWD)" {% if "OPEN (PWD)" == request.GET.category %}selected{% endif %}>Open-PWD</option>
                            <option value="EWS" {% if "EWS" == request.GET.category %}selected{% endif %}>EWS</option>
                            <option value="EWS (PWD)" {% if "EWS (PWD)" == request.GET.category %}selected{% endif %}>EWS-PWD</option>
                            <option value="SC" {% if "SC" == request.GET.category %}selected{% endif %}>SC</option>
                            <option value="SC (PWD)" {% if "SC (PWD)" == request.GET.category %}selected{% endif %}>SC-PWD</option>
                            <option value="ST" {% if "ST" == request.GET.category %}selected{% endif %}>ST</option>
                            <option value="ST (PWD)" {% if "ST (PWD)" == request.GET.category %}selected{% endif %}>ST-PWD</option>
                            <option value="OBC-NCL" {% if "OBC-NCL" == request.GET.category %}selected{% endif %}>OBC-NCL</option>
                            <option value="OBC-NCL (PWD)" {% if "OBC-NCL (PWD)" == request.GET.category %}selected{% endif %}>OBC-NCL-PWD</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="gender" class="form-label">Gender</label>
                        <select class="form-select" id="gender" name="gender" required>
                            <option value="">Select Gender</option>
                            <option value="Gender-Neutral" {% if "Gender-Neutral" == request.GET.gender %}selected{% endif %}>Gender-Neutral</option>
                            <option value="Female-only (including Supernumerary)" {% if "Female-only (including Supernumerary)" == request.GET.gender %}selected{% endif %}>Female-only (including Supernumerary)</option>
                        </select>
                    </div>
                    <input type="hidden" id="showTableHidden" name="show_table" value="{% if request.GET.show_table == 'on' %}on{% else %}off{% endif %}">
                    <button type="submit" id="applyFiltersButton" class="btn btn-primary mb-3" disabled>Apply Filters</button>
                </form>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="showTable" {% if request.GET.show_table == 'on' %}checked{% endif %}>
                    <label class="form-check-label" for="showTable">Show Table</label>
                </div>
            </div>
        </nav>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    var showTableCheckbox = document.getElementById('showTable');
    var showTableHidden = document.getElementById('showTableHidden');
    var table = document.getElementById('table_analysis');
    var paginator = document.getElementById('analysis_paginator');
    var applyFiltersButton = document.getElementById('applyFiltersButton');
    var instituteName = document.getElementById('instituteName');
    var category = document.getElementById('category');
    var gender = document.getElementById('gender');

    // Set the initial display based on the checkbox state
    if (showTableCheckbox.checked) {
        table.style.display = '';
        paginator.style.display = '';
    } else {
        table.style.display = 'none';
        paginator.style.display = 'none';
    }

    // Update the hidden input value when the checkbox state changes
    showTableCheckbox.addEventListener('change', function() {
        if (this.checked) {
            table.style.display = '';
            paginator.style.display = '';
            showTableHidden.value = 'on';
        } else {
            table.style.display = 'none';
            paginator.style.display = 'none';
            showTableHidden.value = 'off';
        }
    });

    // Function to check if all dropdowns have a selected value
    function checkDropdowns() {
        if (instituteName.value && category.value && gender.value) {
            applyFiltersButton.disabled = false;
        } else {
            applyFiltersButton.disabled = true;
        }
    }

    // Event listeners for dropdowns
    instituteName.addEventListener('change', checkDropdowns);
    category.addEventListener('change', checkDropdowns);
    gender.addEventListener('change', checkDropdowns);

    // Initial check
    checkDropdowns();

    // Extract data from table for the chart
    var tableRows = document.querySelectorAll('#table_analysis tbody tr');
    var labels = [];
    var openingRanks = [];
    var closingRanks = [];

    tableRows.forEach(function(row) {
        var cells = row.getElementsByTagName('td');
        var institute = cells[0].innerText;
        var branch = cells[3].innerText;
        var openingRank = parseInt(cells[4].innerText);
        var closingRank = parseInt(cells[5].innerText);
        
        labels.push(`${institute} - ${branch}`);
        openingRanks.push(openingRank);
        closingRanks.push(closingRank);
    });

    // Create the chart
    var ctx = document.getElementById('analysis_chart').getContext('2d');
    var chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Opening Rank',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
                data: openingRanks
            }, {
                label: 'Closing Rank',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1,
                data: closingRanks
            }]
        },
        options: {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true
                    }
                }]
            }
        }
    });
});
</script>
{% endblock %}
